<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="上海时钟">
  <meta name="theme-color" content="#0b1020">

  <title>时间大屏 · Time Web</title>

  <style>
    :root{
      --bg: #0b1020;
      --bg-2: #0f172a;
      --card: rgba(255,255,255,.07);
      --card-strong: rgba(255,255,255,.12);
      --text: rgba(255,255,255,.94);
      --muted: rgba(255,255,255,.70);
      --line: rgba(255,255,255,.16);
      --accent: #38bdf8;
      --accent-2: #22c55e;
      --shadow: 0 2.4vmin 6vmin rgba(0,0,0,.35);
      --screen-scale: 1;
      --stage-w: 100vw;
      --stage-h: 100vh;
      --design-vw: calc(var(--stage-w) / 100);
      --design-vh: calc(var(--stage-h) / 100);
      --edge-pad: 0;
      --edge-pad-bottom: 0;
      --panel-bottom-gap: clamp(1.2vmin, calc(2.2 * var(--design-vw)), 2.8vmin);
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg: #f7f8fb;
        --bg-2: #eef2ff;
        --card: rgba(0,0,0,.04);
        --card-strong: rgba(0,0,0,.08);
        --text: rgba(8,15,27,.90);
        --muted: rgba(8,15,27,.62);
        --line: rgba(8,15,27,.12);
        --accent: #0ea5e9;
        --accent-2: #16a34a;
        --shadow: 0 2vmin 5vmin rgba(0,0,0,.12);
      }
    }

    *, *::before, *::after{ box-sizing: border-box; }
    html, body{ height:100%; }

    body{
      margin:0;
      color:var(--text);
      background:
        radial-gradient(90vmin 52vmin at 15% 15%, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(90vmin 62vmin at 85% 20%, rgba(34,197,94,.20), transparent 60%),
        radial-gradient(90vmin 52vmin at 50% 90%, rgba(129,140,248,.18), transparent 60%),
        linear-gradient(160deg, var(--bg), var(--bg-2));
      font-family: "Avenir Next", "HarmonyOS Sans", "PingFang SC", "Microsoft YaHei", "Segoe UI", sans-serif;
      display:flex;
      justify-content:center;
      align-items:center;
      box-sizing:border-box;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
      overflow: hidden;
    }

    body::before{
      content:"";
      position:fixed;
      inset:0;
      background-image: linear-gradient(120deg, rgba(255,255,255,.06) 0%, rgba(255,255,255,0) 38%);
      opacity:.35;
      pointer-events:none;
      mix-blend-mode: screen;
    }

    .screen{
      --agenda-width: 32vmin;
      --day-size: 4.8vmin;
      --day-font-size: 2.8vmin;
      --time-row: 20vh;
      --time-font: clamp(3.6vmin, calc(var(--time-row) * 0.7), 14vmin);
      --date-font: clamp(1.4vmin, calc(var(--time-row) * 0.18), 2.8vmin);
      --meta-font: clamp(1.2vmin, calc(var(--time-row) * 0.16), 1.8vmin);
      --time-btn-h: 3.8vmin;
      --panel-text-scale: 1.12;
      --agenda-time-width: clamp(7.2vmin, calc(var(--day-size) * 1.6), 16vmin);
      --agenda-time-size: calc(clamp(1.5vmin, calc(var(--day-font-size) * 0.68), 2.4vmin) * var(--panel-text-scale));
      --agenda-title-size: calc(clamp(1.6vmin, calc(var(--day-font-size) * 0.72), 2.4vmin) * var(--panel-text-scale));
      --agenda-meta-size: calc(clamp(1.2vmin, calc(var(--day-font-size) * 0.55), 1.8vmin) * var(--panel-text-scale));
      --agenda-date-size: calc(clamp(1.5vmin, calc(var(--day-font-size) * 0.6), 2.2vmin) * var(--panel-text-scale));
      width: 100%;
      height: 100%;
      max-width: var(--stage-w);
      max-height: var(--stage-h);
      display:grid;
      grid-template-columns: minmax(38vmin, 1fr) var(--agenda-width);
      grid-template-rows: var(--time-row) auto;
      grid-template-areas:
        "time time"
        "calendar agenda";
      gap: clamp(1.4vmin, calc(2.2 * var(--design-vw)), 2.4vmin);
      padding: clamp(0.6vmin, calc(1.1 * var(--design-vw)), 1.4vmin);
      box-sizing:border-box;
      align-items:start;
      align-content:start;
      transform: scale(var(--screen-scale));
      transform-origin: top center;
    }

    .time-wrap{
      display:flex;
      align-items:baseline;
      justify-content:center;
      gap: clamp(1.2vmin, 3vw, 2.8vmin);
      flex-wrap:wrap;
      letter-spacing:.04em;
      max-width: 100%;
    }

    .time{
      font-variant-numeric: tabular-nums;
      font-size: var(--time-font);
      line-height:1;
      text-shadow: 0 1.6vmin 3.2vmin rgba(0,0,0,.35);
      white-space: nowrap;
      max-width: 100%;
    }

    .date{
      font-size: var(--date-font);
      color: var(--muted);
      letter-spacing:.08em;
      white-space: nowrap;
    }

    .meta{
      display:flex;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      gap:1.2vmin;
      font-size: var(--meta-font);
      color: var(--muted);
      white-space: normal;
    }

    .time-card{
      grid-area: time;
      justify-self:stretch;
      width:100%;
      max-width: 100%;
      height: 100%;
      min-height: var(--time-row);
      align-items:center;
      justify-content:center;
      gap: clamp(1vmin, calc(1.8 * var(--design-vw)), 1.8vmin);
      text-align:center;
    }

    .time-sub{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-wrap:wrap;
      gap:1.2vmin;
    }

    .time-card .settings-link,
    .time-card .ghost-btn{
      height: var(--time-btn-h);
      font-size: var(--meta-font);
      min-width: clamp(6.4vmin, calc(var(--time-btn-h) * 2.1), 9.2vmin);
      padding: 0 clamp(0.8vmin, calc(var(--time-btn-h) * 0.3), 1.2vmin);
    }

    .today-chip{
      align-self:center;
      padding:1vmin 1.4vmin;
      border-radius:1.2vmin;
      border:0.1vmin solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size: clamp(calc(1.5vmin * var(--panel-text-scale)), calc(2 * var(--design-vw) * var(--panel-text-scale)), calc(2vmin * var(--panel-text-scale)));
      letter-spacing:.06em;
      text-align:center;
      margin-bottom: clamp(1vmin, calc(1.6 * var(--design-vw)), 1.6vmin);
    }

    .calendar-card{
      grid-area: calendar;
      align-self:start;
      height: auto;
      min-height:0;
    }
    .agenda-card{
      grid-area: agenda;
      align-self:start;
      height: auto;
      min-height:0;
    }

    .settings-link,
    .ghost-btn{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width: 8.2vmin;
      height: 3.8vmin;
      padding: 0 1.2vmin;
      border-radius:99.9vmin;
      border:0.1vmin solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      font-size: clamp(1.3vmin, 1.6vw, 1.6vmin);
      line-height:1;
      text-decoration:none;
      cursor:pointer;
      transition: transform .2s ease, background .2s ease;
    }

    .today-btn{
      min-width: 6.4vmin;
      max-width: 8.6vmin;
      padding: 0 1vmin;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .settings-link:hover,
    .ghost-btn:hover{
      background: rgba(255,255,255,.12);
      transform: translateY(-0.1vmin);
    }

    .screen.is-agenda-collapsed{
      grid-template-columns: 1fr;
      grid-template-rows: var(--time-row) auto;
      grid-template-areas:
        "time"
        "calendar";
    }

    .screen.is-agenda-collapsed .agenda-card{ display:none; }

    .card{
      position:relative;
      overflow:hidden;
      border:0.1vmin solid var(--line);
      border-radius: 2.4vmin;
      padding: clamp(1.4vmin, calc(2.2 * var(--design-vw)), 2.6vmin);
      background: linear-gradient(180deg, var(--card), var(--card-strong));
      box-shadow: var(--shadow);
      backdrop-filter: blur(1.4vmin);
      -webkit-backdrop-filter: blur(1.4vmin);
      display:flex;
      flex-direction:column;
      height:100%;
      min-height:0;
    }

    .agenda-card.is-collapsed{
      min-height: unset;
    }

    .agenda-card.is-collapsed .agenda-list,
    .agenda-card.is-collapsed .sync-status{
      display:none;
    }

    .card-header{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:1.2vmin;
      margin-bottom: clamp(1.2vmin, calc(2 * var(--design-vw)), 2vmin);
      flex-wrap: nowrap;
    }

    .card-actions{
      display:flex;
      align-items:center;
      gap:0.8vmin;
      flex-wrap: nowrap;
      justify-content:flex-end;
      min-width: 0;
    }

    .card h2{
      margin:0;
      font-size: clamp(calc(2.2vmin * var(--panel-text-scale)), calc(2.8 * var(--design-vw) * var(--panel-text-scale)), calc(3.2vmin * var(--panel-text-scale)));
      letter-spacing:.06em;
      white-space: nowrap;
    }

    .month-nav{
      display:flex;
      align-items:center;
      gap:0.8vmin;
      min-width: 0;
    }

    .collapse-btn{
      width:3.4vmin;
      height:3.4vmin;
      border-radius:1vmin;
      border:0.1vmin solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size:1.8vmin;
      line-height:1;
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .month-nav button{
      width:3.4vmin;
      height:3.4vmin;
      border-radius:1vmin;
      border:0.1vmin solid var(--line);
      background: rgba(255,255,255,.08);
      color: var(--text);
      font-size:1.8vmin;
      cursor:pointer;
    }

    .month-label{
      font-size: clamp(calc(1.6vmin * var(--panel-text-scale)), calc(1.8 * var(--design-vw) * var(--panel-text-scale)), calc(2vmin * var(--panel-text-scale)));
      color: var(--muted);
      letter-spacing:.04em;
      min-width: 10vmin;
      text-align:center;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .weekdays{
      display:grid;
      grid-template-columns: repeat(7, var(--day-size));
      justify-content:center;
      gap:0.6vmin;
      font-size: clamp(calc(1.4vmin * var(--panel-text-scale)), calc(1.7 * var(--design-vw) * var(--panel-text-scale)), calc(1.8vmin * var(--panel-text-scale)));
      color: var(--muted);
      margin-bottom:1vmin;
      text-align:center;
    }

    .calendar-card{
      --day-size: 4.8vmin;
    }

    .calendar-grid{
      display:grid;
      grid-template-columns: repeat(7, var(--day-size));
      grid-template-rows: repeat(6, var(--day-size));
      gap:0.6vmin;
      flex: 0 0 auto;
      min-height:0;
      align-content:start;
      justify-content:center;
    }

    .day{
      position:relative;
      border-radius:1.4vmin;
      border:0.1vmin solid transparent;
      background: rgba(255,255,255,.05);
      color: var(--text);
      width: var(--day-size);
      height: var(--day-size);
      font-size: var(--day-font-size, clamp(2.2vmin, calc(2.8 * var(--design-vw)), 3.2vmin));
      cursor:pointer;
      font-variant-numeric: tabular-nums;
      transition: transform .2s ease, border .2s ease, background .2s ease;
      display:flex;
      align-items:center;
      justify-content:center;
    }

    .day:hover{ transform: translateY(-0.2vmin); border-color: rgba(255,255,255,.2); }
    .day.is-muted{ opacity:.45; }
    .day.is-today{ border-color: var(--accent); box-shadow: 0 0 0 0.1vmin rgba(56,189,248,.3); }
    .day.is-selected{ background: rgba(56,189,248,.18); border-color: var(--accent); }
    .day.has-events::after{
      content:"";
      position:absolute;
      width:0.6vmin;
      height:0.6vmin;
      border-radius:99.9vmin;
      background: var(--accent-2);
      bottom:1vmin;
      right:1vmin;
      box-shadow: 0 0 1.2vmin rgba(34,197,94,.6);
    }

    .agenda-date{
      font-size: var(--agenda-date-size);
      color: var(--muted);
      letter-spacing:.04em;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .agenda-list{
      display:flex;
      flex-direction:column;
      gap:1.2vmin;
      overflow:auto;
      flex: 1 1 auto;
      padding-right:0.6vmin;
      padding-bottom: clamp(2vmin, calc(2.4 * var(--design-vw)), 3.6vmin);
    }

    .event{
      display:grid;
      grid-template-columns: var(--agenda-time-width) 1fr;
      gap:1.2vmin;
      padding:1.2vmin 1.4vmin;
      border-radius:1.6vmin;
      border:0.1vmin solid var(--line);
      background: rgba(255,255,255,.05);
      overflow:hidden;
    }

    .event-time{
      font-variant-numeric: tabular-nums;
      font-size: var(--agenda-time-size);
      color: var(--accent);
      white-space: normal;
      line-height: 1.2;
      word-break: keep-all;
    }

    .event-title{
      font-size: var(--agenda-title-size);
      font-weight:600;
      margin-bottom:0.4vmin;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .event-meta{
      color: var(--muted);
      font-size: var(--agenda-meta-size);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }

    .empty{
      border:0.1vmin dashed var(--line);
      border-radius:1.6vmin;
      padding:1.8vmin;
      color: var(--muted);
      font-size: calc(1.4vmin * var(--panel-text-scale));
      text-align:center;
    }

    .sync-status{
      position:absolute;
      left: clamp(1.4vmin, calc(2.2 * var(--design-vw)), 2.6vmin);
      right: clamp(1.4vmin, calc(2.2 * var(--design-vw)), 2.6vmin);
      bottom: clamp(1.2vmin, calc(1.8 * var(--design-vw)), 2.2vmin);
      color: var(--muted);
      font-size: clamp(calc(1.1vmin * var(--panel-text-scale)), calc(1.3 * var(--design-vw) * var(--panel-text-scale)), calc(1.3vmin * var(--panel-text-scale)));
      pointer-events:none;
    }

    @media (max-width: 82vmin){
      .time-sub{ flex-direction:column; align-items:center; }
    }
  </style>
</head>

<body>
  <main class="screen">
    <section class="card time-card" aria-label="时间">
      <div class="time-wrap">
        <div class="time" id="timeText">--:--</div>
      </div>
      <div class="time-sub">
        <div class="meta">
          <span id="tzLabel">Asia/Shanghai</span>
          <button class="ghost-btn" type="button" id="fullscreenBtn">全屏</button>
          <a class="settings-link" href="settings.html">设置</a>
        </div>
      </div>
    </section>

    <section class="card calendar-card" aria-label="日历">
        <div class="card-header">
          <h2>日历</h2>
          <div class="card-actions">
            <button class="ghost-btn today-btn" type="button" id="todayBtn">今天</button>
            <div class="month-nav">
              <button type="button" id="prevMonth" aria-label="上个月">‹</button>
              <div class="month-label" id="monthLabel"></div>
              <button type="button" id="nextMonth" aria-label="下个月">›</button>
            </div>
            <button class="collapse-btn" type="button" id="toggleAgenda" aria-expanded="true" aria-label="折叠日程">-</button>
          </div>
        </div>
        <div class="today-chip" id="dateText">----</div>
        <div class="weekdays" id="weekdayRow"></div>
        <div class="calendar-grid" id="calendarGrid"></div>
      </section>

      <section class="card agenda-card" aria-label="日程">
        <div class="card-header">
          <h2>日程</h2>
          <div class="agenda-date" id="agendaDate"></div>
        </div>
        <div class="agenda-list" id="agendaList"></div>
        <div class="sync-status" id="syncStatus">日历订阅：未配置</div>
      </section>
  </main>

  <script>
    const DEFAULT_CONFIG = {
      timezone: "Asia/Shanghai",
      hour12: false,
      showSeconds: true,
      weekStart: 1,
      subscriptions: [],
      events: [
        { date: "2026-01-29", time: "09:30", end: "10:30", title: "产品评审", location: "会议室 A", source: "手动" },
        { date: "2026-01-29", time: "13:00", end: "14:00", title: "项目同步", location: "线上会议", source: "手动" },
        { date: "2026-01-29", time: "17:30", end: "18:00", title: "日报整理", location: "发送前确认", source: "手动" }
      ]
    };

    const storageKey = "tw_config";

    function clone(obj){
      return JSON.parse(JSON.stringify(obj));
    }

    function escapeAttr(value){
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/"/g, "&quot;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;");
    }

    function clamp(min, value, max){
      return Math.min(Math.max(value, min), max);
    }

    function toVw(px){
      const width = window.innerWidth || 1;
      return (px * 100) / width;
    }

    function toVh(px){
      const height = window.innerHeight || 1;
      return (px * 100) / height;
    }

    function toVmin(px){
      const minDim = Math.min(window.innerWidth || 1, window.innerHeight || 1);
      return (px * 100) / minDim;
    }

    function getCookie(name){
      const escaped = name.replace(/([.$?*|{}()[\]\\/+^])/g, "\\$1");
      const match = document.cookie.match(new RegExp("(?:^|; )" + escaped + "=([^;]*)"));
      return match ? match[1] : null;
    }

    function canUseLocalStorage(){
      try {
        const testKey = "__tw_test__";
        localStorage.setItem(testKey, "1");
        localStorage.removeItem(testKey);
        return true;
      } catch (err){
        return false;
      }
    }

    function readStored(){
      let raw = null;
      if (canUseLocalStorage()){
        raw = localStorage.getItem(storageKey);
      }
      if (!raw){
        raw = getCookie(storageKey);
      }
      return raw;
    }

    function loadConfig(){
      const raw = readStored();
      if (!raw) return clone(DEFAULT_CONFIG);
      try {
        const parsed = JSON.parse(decodeURIComponent(raw));
        const config = { ...clone(DEFAULT_CONFIG), ...parsed };
        config.events = Array.isArray(parsed.events) ? parsed.events : clone(DEFAULT_CONFIG.events);
        config.subscriptions = Array.isArray(parsed.subscriptions) ? parsed.subscriptions : [];
        return config;
      } catch (err){
        return clone(DEFAULT_CONFIG);
      }
    }

    function formatDateKey(year, monthIndex, day){
      const mm = String(monthIndex + 1).padStart(2, "0");
      const dd = String(day).padStart(2, "0");
      return `${year}-${mm}-${dd}`;
    }

    function getTodayString(timeZone){
      const fmt = new Intl.DateTimeFormat("en-CA", {
        timeZone,
        year: "numeric",
        month: "2-digit",
        day: "2-digit"
      });
      return fmt.format(new Date());
    }

    function getWeekdayIndex(year, monthIndex, day, timeZone){
      const date = new Date(Date.UTC(year, monthIndex, day, 12, 0, 0));
      const weekday = new Intl.DateTimeFormat("en-US", { timeZone, weekday: "short" }).format(date);
      const map = { Sun:0, Mon:1, Tue:2, Wed:3, Thu:4, Fri:5, Sat:6 };
      return map[weekday];
    }

    function buildWeekdaysRow(weekStart){
      const labels = ["日", "一", "二", "三", "四", "五", "六"];
      const row = [];
      for (let i=0; i<7; i++){
        row.push(labels[(weekStart + i) % 7]);
      }
      return row;
    }

    function formatDateDisplay(dateStr, timeZone){
      const [year, month, day] = dateStr.split("-").map(Number);
      const date = new Date(Date.UTC(year, month - 1, day, 12, 0, 0));
      const fmt = new Intl.DateTimeFormat("zh-CN", {
        timeZone,
        year: "numeric",
        month: "long",
        day: "numeric",
        weekday: "short"
      });
      return fmt.format(date);
    }

    function parseIcsDate(value, params, timeZone){
      if (!value) return null;
      const isDateOnly = params.VALUE === "DATE" || value.length === 8;
      if (isDateOnly){
        return { date: `${value.slice(0,4)}-${value.slice(4,6)}-${value.slice(6,8)}`, allDay: true };
      }
      const hasZ = value.endsWith("Z");
      const tzid = params.TZID || null;
      const raw = value.replace("Z", "");
      const year = Number(raw.slice(0,4));
      const month = Number(raw.slice(4,6));
      const day = Number(raw.slice(6,8));
      const hour = Number(raw.slice(9,11) || 0);
      const minute = Number(raw.slice(11,13) || 0);
      const second = Number(raw.slice(13,15) || 0);

      if (hasZ){
        const date = new Date(Date.UTC(year, month - 1, day, hour, minute, second));
        const fmt = new Intl.DateTimeFormat("en-CA", {
          timeZone,
          year: "numeric",
          month: "2-digit",
          day: "2-digit",
          hour: "2-digit",
          minute: "2-digit",
          hour12: false
        });
        const parts = fmt.formatToParts(date);
        const get = (type) => parts.find(p => p.type === type)?.value || "";
        return {
          date: `${get("year")}-${get("month")}-${get("day")}`,
          time: `${get("hour")}:${get("minute")}`,
          tzid
        };
      }

      return {
        date: `${String(year).padStart(4,"0")}-${String(month).padStart(2,"0")}-${String(day).padStart(2,"0")}`,
        time: `${String(hour).padStart(2,"0")}:${String(minute).padStart(2,"0")}`,
        tzid
      };
    }

    function parseIcs(text, timeZone){
      const lines = text.replace(/\r\n/g, "\n").replace(/\r/g, "\n").split("\n");
      const unfolded = [];
      for (const line of lines){
        if (line.startsWith(" ") || line.startsWith("\t")){
          if (unfolded.length) unfolded[unfolded.length - 1] += line.slice(1);
        } else {
          unfolded.push(line);
        }
      }

      const events = [];
      let current = null;

      for (const line of unfolded){
        if (line === "BEGIN:VEVENT"){
          current = {};
          continue;
        }
        if (line === "END:VEVENT"){
          if (current && current.dtstart){
            events.push(current);
          }
          current = null;
          continue;
        }
        if (!current) continue;

        const match = line.match(/^([^:]+):(.*)$/);
        if (!match) continue;
        const rawKey = match[1];
        const value = match[2];
        const parts = rawKey.split(";");
        const key = parts[0].toUpperCase();
        const params = {};
        for (const part of parts.slice(1)){
          const [pKey, pValue] = part.split("=");
          if (pKey && pValue) params[pKey.toUpperCase()] = pValue;
        }

        if (key === "SUMMARY") current.summary = value;
        if (key === "LOCATION") current.location = value;
        if (key === "DTSTART") current.dtstart = parseIcsDate(value, params, timeZone);
        if (key === "DTEND") current.dtend = parseIcsDate(value, params, timeZone);
      }

      return events.map(item => {
        const data = item.dtstart || {};
        return {
          date: data.date,
          time: data.time,
          end: item.dtend ? item.dtend.time : "",
          allDay: data.allDay,
          title: item.summary || "(无标题)",
          location: item.location || "",
          source: "订阅"
        };
      });
    }

    const config = loadConfig();
    const MIN_AGENDA_SHARE = 0.20;
    const MAX_AGENDA_SHARE = 0.50;

    const screenEl = document.querySelector(".screen");
    const timeCard = document.querySelector(".time-card");
    const timeWrap = document.querySelector(".time-wrap");
    const timeSub = document.querySelector(".time-sub");
    const calendarCard = document.querySelector(".calendar-card");
    const timeEl = document.getElementById("timeText");
    const dateEl = document.getElementById("dateText");
    const tzLabel = document.getElementById("tzLabel");
    const monthLabel = document.getElementById("monthLabel");
    const calendarGrid = document.getElementById("calendarGrid");
    const agendaList = document.getElementById("agendaList");
    const agendaDate = document.getElementById("agendaDate");
    const weekdayRow = document.getElementById("weekdayRow");
    const syncStatus = document.getElementById("syncStatus");
    const agendaCard = document.querySelector(".agenda-card");
    const toggleAgenda = document.getElementById("toggleAgenda");
    const fullscreenBtn = document.getElementById("fullscreenBtn");
    const todayBtn = document.getElementById("todayBtn");

    tzLabel.textContent = config.timezone;
    weekdayRow.innerHTML = buildWeekdaysRow(config.weekStart).map(label => `<div>${label}</div>`).join("");

    let selectedDate = getTodayString(config.timezone);
    let [viewYear, viewMonth] = selectedDate.split("-").map((value, idx) => idx === 1 ? Number(value) - 1 : Number(value));
    let eventMap = {};
    let agendaCollapsed = false;

    function updateTimeSizing(){
      if (!timeCard || !screenEl) return;
      const style = getComputedStyle(timeCard);
      const padY = parseFloat(style.paddingTop) + parseFloat(style.paddingBottom);
      const padX = parseFloat(style.paddingLeft) + parseFloat(style.paddingRight);
      const gap = parseFloat(style.rowGap || style.gap) || 0;
      const availableH = Math.max(0, timeCard.clientHeight - padY);
      const availableW = Math.max(0, timeCard.clientWidth - padX);
      if (!availableH || !availableW) return;

      const btnHeight = clamp(24, availableH * 0.28, 44);
      const metaFont = clamp(11, availableH * 0.14, 22);
      screenEl.style.setProperty("--time-btn-h", `${toVh(btnHeight).toFixed(3)}vh`);
      screenEl.style.setProperty("--meta-font", `${toVh(metaFont).toFixed(3)}vh`);

      const metaHeight = timeSub ? timeSub.offsetHeight : 0;
      const timeAvailable = Math.max(0, availableH - metaHeight - gap);
      let timeFont = clamp(26, timeAvailable * 0.9, 180);
      screenEl.style.setProperty("--time-font", `${toVh(timeFont).toFixed(3)}vh`);

      if (timeWrap && timeEl){
        const total = timeWrap.offsetHeight + metaHeight + gap;
        if (total > availableH && timeFont > 20){
          const scale = availableH / total;
          timeFont = Math.max(20, Math.floor(timeFont * scale));
        }
        const timeWidth = timeEl.scrollWidth;
        if (timeWidth > availableW && timeWidth > 0){
          const scale = availableW / timeWidth;
          timeFont = Math.max(20, Math.floor(timeFont * scale));
        }
        screenEl.style.setProperty("--time-font", `${toVh(timeFont).toFixed(3)}vh`);
      }
    }

    function updateAgendaWidth(){
      if (!screenEl || agendaCollapsed) return;
      const style = getComputedStyle(screenEl);
      const padX = parseFloat(style.paddingLeft) + parseFloat(style.paddingRight);
      const available = Math.max(0, screenEl.clientWidth - padX);
      if (!available) return;

      const minByShare = available * MIN_AGENDA_SHARE;
      const maxByShare = available * MAX_AGENDA_SHARE;
      const minPx = minByShare;
      const maxPx = Math.max(minPx, maxByShare);
      const target = Math.max(0, maxPx);

      screenEl.style.setProperty("--agenda-width", `${toVw(Math.max(0, target)).toFixed(3)}vw`);
    }

    function updateCalendarGridSize(){
      if (!calendarGrid || !calendarCard) return;
      const style = getComputedStyle(calendarGrid);
      const cardStyle = getComputedStyle(calendarCard);
      const screenStyle = getComputedStyle(screenEl);
      const bodyStyle = getComputedStyle(document.body);
      const gapX = parseFloat(style.columnGap) || parseFloat(style.gap) || 0;
      const gapY = parseFloat(style.rowGap) || parseFloat(style.gap) || 0;
      const rowGap = parseFloat(screenStyle.rowGap || screenStyle.gap) || 0;
      const cols = 7;
      const rows = 6;
      const padX = parseFloat(cardStyle.paddingLeft) + parseFloat(cardStyle.paddingRight);
      const availableW = Math.max(0, calendarCard.clientWidth - padX);
      if (!availableW) return;
      const padY = parseFloat(cardStyle.paddingTop) + parseFloat(cardStyle.paddingBottom);
      const screenPadY = parseFloat(screenStyle.paddingTop) + parseFloat(screenStyle.paddingBottom);
      const bodyPadY = parseFloat(bodyStyle.paddingTop) + parseFloat(bodyStyle.paddingBottom);
      const headerEl = calendarCard.querySelector(".card-header");
      const chipEl = calendarCard.querySelector(".today-chip");
      const weekdaysEl = calendarCard.querySelector(".weekdays");
      const headerH = headerEl ? headerEl.offsetHeight : 0;
      const chipH = chipEl ? chipEl.offsetHeight : 0;
      const weekdaysH = weekdaysEl ? weekdaysEl.offsetHeight : 0;
      const headerMargin = headerEl ? parseFloat(getComputedStyle(headerEl).marginBottom) || 0 : 0;
      const weekdaysMargin = weekdaysEl ? parseFloat(getComputedStyle(weekdaysEl).marginBottom) || 0 : 0;
      const timeH = timeCard ? timeCard.offsetHeight : 0;
      const viewportH = window.innerHeight || 0;
      const maxRowH = Math.max(0, viewportH - bodyPadY - screenPadY - timeH - rowGap);
      const availableH = Math.max(0, maxRowH - padY - headerH - chipH - weekdaysH - headerMargin - weekdaysMargin);

      const sizeByWidth = (availableW - gapX * (cols - 1)) / cols;
      const sizeByHeight = availableH > 0 ? (availableH - gapY * (rows - 1)) / rows : sizeByWidth;
      const daySize = Math.max(1, Math.floor(Math.min(sizeByWidth, sizeByHeight)));
      const headerTitle = calendarCard.querySelector(".card-header h2");
      const headerFont = headerTitle ? parseFloat(getComputedStyle(headerTitle).fontSize) : daySize * 0.7;
      const dayFont = Math.max(1, Math.min(Math.round(daySize * 0.9), Math.round(headerFont)));
      calendarCard.style.setProperty("--day-size", `${toVmin(daySize).toFixed(3)}vmin`);
      calendarCard.style.setProperty("--day-font-size", `${toVmin(dayFont).toFixed(3)}vmin`);
      screenEl.style.setProperty("--day-size", `${toVmin(daySize).toFixed(3)}vmin`);
      screenEl.style.setProperty("--day-font-size", `${toVmin(dayFont).toFixed(3)}vmin`);
      calendarGrid.style.height = `${toVmin(daySize * rows + gapY * (rows - 1)).toFixed(3)}vmin`;
      syncCardHeights();
    }

    function syncCardHeights(){
      if (!calendarCard || !agendaCard) return;
      if (agendaCollapsed){
        agendaCard.style.height = "";
        agendaCard.style.maxHeight = "";
        return;
      }
      calendarCard.style.height = "";
      calendarCard.style.maxHeight = "";
      agendaCard.style.height = "";
      agendaCard.style.maxHeight = "";
    }

    function setAgendaCollapsed(next, options = {}){
      const { skipResync = false } = options;
      agendaCollapsed = next;
      agendaCard.classList.toggle("is-collapsed", agendaCollapsed);
      screenEl.classList.toggle("is-agenda-collapsed", agendaCollapsed);
      if (agendaCollapsed){
        agendaCard.style.height = "";
        agendaCard.style.maxHeight = "";
      }
      toggleAgenda.setAttribute("aria-expanded", String(!agendaCollapsed));
      toggleAgenda.textContent = agendaCollapsed ? "+" : "-";
      toggleAgenda.setAttribute("aria-label", agendaCollapsed ? "展开日程" : "折叠日程");
      if (!skipResync){
        updateAgendaWidth();
        updateCalendarGridSize();
        updateScale();
      }
    }

    function buildEventMap(events){
      const map = {};
      for (const event of events){
        if (!event.date) continue;
        if (!map[event.date]) map[event.date] = [];
        map[event.date].push(event);
      }
      return map;
    }

    function renderCalendar(){
      const daysInMonth = new Date(Date.UTC(viewYear, viewMonth + 1, 0)).getUTCDate();
      const prevMonthDays = new Date(Date.UTC(viewYear, viewMonth, 0)).getUTCDate();
      const firstDow = getWeekdayIndex(viewYear, viewMonth, 1, config.timezone);
      const leading = (firstDow - config.weekStart + 7) % 7;
      const todayStr = getTodayString(config.timezone);

      monthLabel.textContent = `${viewYear}年 ${viewMonth + 1}月`;
      calendarGrid.innerHTML = "";

      for (let i = 0; i < 42; i++){
        let dayNum;
        let cellMonth = viewMonth;
        let cellYear = viewYear;
        let inMonth = true;

        if (i < leading){
          dayNum = prevMonthDays - leading + i + 1;
          cellMonth = viewMonth - 1;
          cellYear = viewYear;
          if (cellMonth < 0){ cellMonth = 11; cellYear -= 1; }
          inMonth = false;
        } else if (i >= leading + daysInMonth){
          dayNum = i - (leading + daysInMonth) + 1;
          cellMonth = viewMonth + 1;
          cellYear = viewYear;
          if (cellMonth > 11){ cellMonth = 0; cellYear += 1; }
          inMonth = false;
        } else {
          dayNum = i - leading + 1;
        }

        const dateStr = formatDateKey(cellYear, cellMonth, dayNum);
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "day";
        btn.textContent = dayNum;
        btn.dataset.date = dateStr;

        if (!inMonth) btn.classList.add("is-muted");
        if (dateStr === selectedDate) btn.classList.add("is-selected");
        if (dateStr === todayStr) btn.classList.add("is-today");
        if (eventMap[dateStr]) btn.classList.add("has-events");

        btn.addEventListener("click", () => {
          selectedDate = dateStr;
          viewYear = cellYear;
          viewMonth = cellMonth;
          renderCalendar();
          renderAgenda();
        });

        calendarGrid.appendChild(btn);
      }
      updateCalendarGridSize();
      syncCardHeights();
    }

    function renderAgenda(){
      agendaDate.textContent = formatDateDisplay(selectedDate, config.timezone);
      const events = (eventMap[selectedDate] || []).slice().sort((a, b) => {
        const timeA = a.allDay ? "00:00" : (a.time || "99:99");
        const timeB = b.allDay ? "00:00" : (b.time || "99:99");
        return timeA.localeCompare(timeB);
      });

      if (!events.length){
        agendaList.innerHTML = `<div class="empty">暂无日程</div>`;
        return;
      }

      agendaList.innerHTML = events.map(event => {
        const timeText = event.allDay ? "全天" : (event.time || "待定");
        const range = event.end ? ` - ${event.end}` : "";
        const metaParts = [];
        if (event.location) metaParts.push(event.location);
        if (event.source) metaParts.push(event.source);
        const metaDisplay = metaParts.join(" · ");
        const metaText = metaDisplay ? ` · ${metaDisplay}` : "";
        const titleAttr = escapeAttr(event.title || "");
        const metaAttr = escapeAttr(metaDisplay);
        return `
          <div class="event">
            <div class="event-time">${timeText}${range}</div>
            <div>
              <div class="event-title" title="${titleAttr}">${event.title}</div>
              <div class="event-meta" title="${metaAttr}">${metaText}</div>
            </div>
          </div>
        `;
      }).join("");
      syncCardHeights();
    }

    function updateScale(){
      document.documentElement.style.setProperty("--screen-scale", "1");
      syncCardHeights();
    }

    function handleResize(){
      updateAgendaWidth();
      updateCalendarGridSize();
      updateTimeSizing();
      updateScale();
      syncCardHeights();
    }

    function updateFullscreenLabel(){
      const isFullscreen = !!document.fullscreenElement;
      fullscreenBtn.textContent = isFullscreen ? "退出全屏" : "全屏";
    }

    function updateClock(){
      const now = new Date();
      const timeOptions = {
        timeZone: config.timezone,
        hour: "2-digit",
        minute: "2-digit",
        hour12: config.hour12
      };
      if (config.showSeconds) timeOptions.second = "2-digit";
      const timeFormatter = new Intl.DateTimeFormat("zh-CN", timeOptions);
      const parts = new Intl.DateTimeFormat("zh-CN", {
        timeZone: config.timezone,
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        weekday: "short"
      }).formatToParts(now);
      const get = (type) => parts.find(p => p.type === type)?.value || "";
      dateEl.textContent = `${get("year")}年${get("month")}月${get("day")}日 ${get("weekday")}`;
      timeEl.textContent = timeFormatter.format(now);
    }

    async function loadSubscriptionEvents(){
      if (!config.subscriptions.length){
        syncStatus.textContent = "日历订阅：未配置";
        return [];
      }

      syncStatus.textContent = "日历订阅：同步中...";
      const tasks = config.subscriptions.map(async (url) => {
        const response = await fetch(url, { cache: "no-cache" });
        if (!response.ok) throw new Error(`订阅失败：${url}`);
        const text = await response.text();
        return parseIcs(text, config.timezone);
      });

      const results = await Promise.allSettled(tasks);
      const events = [];
      const errors = [];
      for (const result of results){
        if (result.status === "fulfilled"){
          events.push(...result.value);
        } else {
          errors.push(result.reason?.message || "订阅失败");
        }
      }

      if (errors.length){
        syncStatus.textContent = `日历订阅：${events.length} 条（部分失败）`;
      } else {
        syncStatus.textContent = `日历订阅：${events.length} 条已同步`;
      }

      return events;
    }

    async function init(){
      updateClock();
      setInterval(updateClock, config.showSeconds ? 1000 : 60000);

      const manualEvents = Array.isArray(config.events) ? config.events : [];
      const subscriptionEvents = await loadSubscriptionEvents();
      eventMap = buildEventMap([...manualEvents, ...subscriptionEvents]);

      renderCalendar();
      renderAgenda();
      setAgendaCollapsed(false);
    }

    document.getElementById("prevMonth").addEventListener("click", () => {
      viewMonth -= 1;
      if (viewMonth < 0){ viewMonth = 11; viewYear -= 1; }
      renderCalendar();
    });

    document.getElementById("nextMonth").addEventListener("click", () => {
      viewMonth += 1;
      if (viewMonth > 11){ viewMonth = 0; viewYear += 1; }
      renderCalendar();
    });

    todayBtn.addEventListener("click", () => {
      selectedDate = getTodayString(config.timezone);
      const [year, month] = selectedDate.split("-").map((value, idx) => idx === 1 ? Number(value) - 1 : Number(value));
      viewYear = year;
      viewMonth = month;
      renderCalendar();
      renderAgenda();
    });

    toggleAgenda.addEventListener("click", () => {
      setAgendaCollapsed(!agendaCollapsed);
    });

    fullscreenBtn.addEventListener("click", async () => {
      try {
        if (!document.fullscreenElement && document.documentElement.requestFullscreen) {
          await document.documentElement.requestFullscreen();
        } else if (document.exitFullscreen) {
          await document.exitFullscreen();
        }
      } catch (err) {}
      updateFullscreenLabel();
    });

    document.addEventListener("fullscreenchange", () => {
      updateFullscreenLabel();
      updateAgendaWidth();
      updateTimeSizing();
      updateScale();
    });
    window.addEventListener("resize", handleResize);

    init();
    handleResize();
    updateFullscreenLabel();
  </script>
</body>
</html>
